<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Portal do Administrador</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    
    <nav class="navbar navbar-expand-lg navbar-dark bg-danger">
        <div class="container">
            <a class="navbar-brand" href="#">Portal do Administrador</a>
            <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                <li class="nav-item"><a class="nav-link" href="#" id="nome-usuario"></a></li>
                <li class="nav-item"><button class="btn btn-outline-warning btn-sm" id="btn-logout">Sair</button></li>
            </ul>
        </div>
    </nav>

    <div class="container mt-4">
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tecnicos-tab" data-bs-toggle="tab" data-bs-target="#tecnicos-pane">Gerir Técnicos</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="atendentes-tab" data-bs-toggle="tab" data-bs-target="#atendentes-pane">Gerir Atendentes</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="relatorios-tab" data-bs-toggle="tab" data-bs-target="#relatorios-pane">Relatórios</button>
            </li>
        </ul>

        <div class="tab-content p-3 card" id="myTabContent">
            <div class="tab-pane fade show active" id="tecnicos-pane" role="tabpanel">
                <h3 class="mb-3">Novo Técnico</h3>
                <div id="alerta-tecnico" class="alert d-none"></div>
                <form id="form-tecnico">
                    <div class="row">
                        <div class="col-md-6 mb-3"><label>Nome:</label><input type="text" id="tec-nome" class="form-control" required></div>
                        <div class="col-md-6 mb-3"><label>CPF:</label><input type="text" id="tec-cpf" class="form-control" required></div>
                        <div class="col-md-6 mb-3"><label>Data Nasc.:</label><input type="date" id="tec-data" class="form-control" required></div>
                        <div class="col-12 mb-3"><label>Endereço:</label><input type="text" id="tec-endereco" class="form-control"></div>
                    </div>
                    <button type="submit" class="btn btn-primary">Salvar Técnico</button>
                </form>
            </div>

            <div class="tab-pane fade" id="atendentes-pane" role="tabpanel">
                 <h3 class="mb-3">Novo Atendente</h3>
                <div id="alerta-atendente" class="alert d-none"></div>
                <form id="form-atendente">
                    <div class="row">
                        <div class="col-md-6 mb-3"><label>Nome:</label><input type="text" id="ate-nome" class="form-control" required></div>
                        <div class="col-md-6 mb-3"><label>CPF:</label><input type="text" id="ate-cpf" class="form-control" required></div>
                        <div class="col-md-6 mb-3"><label>Data Nasc.:</label><input type="date" id="ate-data" class="form-control" required></div>
                        <div class="col-12 mb-3"><label>Endereço:</label><input type="text" id="ate-endereco" class="form-control"></div>
                    </div>
                    <button type="submit" class="btn btn-primary">Salvar Atendente</button>
                </form>
            </div>
            
            <div class="tab-pane fade" id="relatorios-pane" role="tabpanel">
                <h3 class="mb-3">Ordens de Serviço por Status</h3>
                <div style="max-width: 400px; margin: auto;">
                    <canvas id="grafico-os-status"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const usuario = Auth.checkAuth('admin');
            document.getElementById('nome-usuario').textContent = `Olá, ${usuario.nome}`;
            document.getElementById('btn-logout').addEventListener('click', Auth.logout);
            carregarGraficoOS();
        });

        // Salvar Novo Técnico
        document.getElementById('form-tecnico').addEventListener('submit', async (e) => {
            e.preventDefault();
            const dto = {
                nome: document.getElementById('tec-nome').value,
                cpf: document.getElementById('tec-cpf').value,
                dataNascimento: document.getElementById('tec-data').value,
                endereco: document.getElementById('tec-endereco').value
            };
            
            const response = await Api.salvar('tecnicos', dto);
            if (response.ok) {
                Utils.mostrarAlerta('alerta-tecnico', 'Técnico salvo com sucesso!', 'success');
                e.target.reset();
            } else {
                const erro = await response.text();
                Utils.mostrarAlerta('alerta-tecnico', `Erro: ${erro}`, 'danger');
            }
        });
        
        // Salvar Novo Atendente
        document.getElementById('form-atendente').addEventListener('submit', async (e) => {
            e.preventDefault();
            const dto = {
                nome: document.getElementById('ate-nome').value,
                cpf: document.getElementById('ate-cpf').value,
                dataNascimento: document.getElementById('ate-data').value,
                endereco: document.getElementById('ate-endereco').value
            };
            
            const response = await Api.salvar('atendentes', dto);
            if (response.ok) {
                Utils.mostrarAlerta('alerta-atendente', 'Atendente salvo com sucesso!', 'success');
                e.target.reset();
            } else {
                const erro = await response.text();
                Utils.mostrarAlerta('alerta-atendente', `Erro: ${erro}`, 'danger');
            }
        });


        // Carregar o Gráfico (Relatório)
        async function carregarGraficoOS() {
            // Esta função não está no app.js, vamos chamá-la diretamente
            const response = await fetch(`${API_URL}/os`);
            if (!response.ok) return;
            const ordens = await response.json();
            
            const contagemStatus = {
                ABERTA: 0, AGUARDANDO_ORCAMENTO: 0, AGUARDANDO_APROVACAO: 0,
                EM_REPARO: 0, FINALIZADA: 0, CANCELADA: 0
            };
            
            ordens.forEach(os => {
                if(contagemStatus.hasOwnProperty(os.estado)) {
                    contagemStatus[os.estado]++;
                }
            });

            const ctx = document.getElementById('grafico-os-status');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(contagemStatus),
                    datasets: [{
                        label: '# de OS',
                        data: Object.values(contagemStatus),
                        backgroundColor: [
                            '#0d6efd', '#ffc107', '#fd7e14', 
                            '#198754', '#6f42c1', '#dc3545'
                        ]
                    }]
                }
            });
        }
    </script>
</body>
</html>